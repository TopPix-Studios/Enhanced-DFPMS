{% extends "admin/profile_chart.html" %}
{% load static %}
{% block chart_content %}

  <div class="col-md-11">
    <hr>
    <form id="filtersForm" method="GET" class="filter-form">
      <div class="container">
        <h5 class="text-bold">Region Filter:</h5>
        <div id="regionFilters" class="form-group">
          <label for="regionFilter">Region:</label>
          <select id="regionFilter" name="region" class="form-control">
            <option value="">All</option>
            {% for region in unique_regions %} <!-- Display region filters -->
            <option value="{{ region }}" {% if request.GET.region == region %}selected{% endif %}>{{ region }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <hr>
      <div class="form-group full-width d-flex align-items-end">
          <button type="submit" id="submitFilters" class="btn btn-primary">Search</button>
      </div>
    </form>
  
  </div>
  <br>
 
  <div id="regionChartDiv" class="chart-container">
    <h3 class="text-bold">Freelancer Regional Distribution Chart <i class="fas fa-info-circle" id="chartInfoIcon" style="font-size: 16px;"></i></h3>
    <canvas id="regionChart"></canvas>
  </div>

  <hr>
  <div class="container analysis-section">
    <h2 class="text-bold">Analysis of Region Distribution Chart</h2>
    <p>This section provides insights into the trends and patterns observed in the Region Distribution Chart.</p>
    <ul>
        {% for insight in insights %}
            <li>{{ insight|safe }}</li>
        {% endfor %}
    </ul>
  </div>
  
  <div class="form-group d-flex flex-row justify-content-end align-items-center gap-2" style="width: 70vw;">
  
    <!-- Export to PDF -->
    <button type="button" id="exportButton" class="btn btn-secondary w-50 mx-2" style="height: 50px;">Export to PDF</button>
  
    <!-- Export to Excel -->
    <button type="button" class="btn btn-primary w-50 mx-2" style="height: 50px;" onclick="exportRegionChartToExcel()">Export to Excel</button>
  
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    tippy('#chartInfoIcon', {
        content: 'This chart shows the distribution of users per region. Use the region filters above to adjust data to a specific region.',
        placement: 'top',
    });

    // Data for the chart
    const regionData = {{ region_data|safe }};
    const regionLabels = regionData.map(e => e['region__region']);
    const regionCounts = regionData.map(e => e.count);

    // Create the chart
    const regionCtx = document.getElementById('regionChart').getContext('2d');
    const regionChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
            labels: regionLabels,
            datasets: [{
                label: 'Region Distribution',
                data: regionCounts,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
            }],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                },
            },
        },
    });

    // Export chart and data to PDF using generatePDF.js
    document.getElementById('exportButton').addEventListener('click', function () {
        const chartImageData = regionChart.toBase64Image();
        const regionFilter = "{{ request.GET.region|default:'ALL' }}";
        const filters = `Region: ${regionFilter}`;

        const tableHeaders = ['Region', '# of Users'];
        const tableData = regionLabels.map((region, index) => [region, regionCounts[index]]);

        generatePDF({
            title: 'Freelancer Regional Distribution Report',
            chartImageData: chartImageData,
            filters: filters,
            tableHeaders: tableHeaders,
            tableData: tableData,
            fileName: 'freelancer_regional_distribution_summary.pdf',
           
        });
    });

    function exportRegionChartToExcel() {
      const region = document.getElementById('regionFilter').value;
      const params = new URLSearchParams();
      if (region) params.append('region', region);
  
      window.location.href = `/export-region-chart-excel/?${params.toString()}`;
  }
  
  
</script>

{% endblock %}
