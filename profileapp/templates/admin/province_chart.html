{% extends "admin/profile_chart.html" %}
{% load static %}
{% block chart_content %}
  <div class="col-md-11">
    <hr>
    <div id="filters">
      <form id="filtersForm" method="GET" class="filter-form">
        <h5 class="text-bold">Province Filter:</h5>
        <div id="provinceFilters" class="form-group">
          <label for="provinceFilter">Province:</label>
          <select id="provinceFilter" name="province" class="form-control">
            <option value="">All</option>
            {% for province in unique_provinces %}
            <option value="{{ province }}" {% if request.GET.province == province %}selected{% endif %}>{{ province }}</option>
            {% endfor %}
          </select>
        </div>
        <hr>
        <div class="form-group full-width d-flex align-items-end">
          <button type="submit" id="submitFilters" class="btn btn-primary">Search</button>
        </div>
      </form>
    </div>
    <div id="provinceChartDiv" class="chart-container">
      <h3 class="text-bold">Freelancer Province Distribution Chart <i class="fas fa-info-circle" id="chartInfoIcon" style="font-size: 16px;"></i></h3>
      <canvas id="provinceChart"></canvas>
    </div>
    <hr>
    <div class="container analysis-section">
      <h2 class="text-bold">Analysis of Province Distribution Chart</h2>
      <p>This section provides insights into the trends and patterns observed in the Province Distribution Chart.</p>
      <ul>
        {% for insight in insights %}
          <li>{{ insight|safe }}</li>
        {% endfor %}
      </ul>
    </div>
    <!-- Export buttons -->
    <div class="form-group d-flex flex-row justify-content-end align-items-center gap-2" style="width: 70vw;">
      
      <!-- Export to PDF -->
      <button type="button" id="exportButton" class="btn btn-secondary w-50 mx-2" style="height: 50px;">Export to PDF</button>

      <!-- Export to Excel -->
      <button type="button" class="btn btn-primary w-50 mx-2" style="height: 50px;" onclick="exportProvinceChartToExcel()">Export to Excel</button>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    tippy('#chartInfoIcon', {
        content: 'This chart shows the distribution of users per province. Use the province filters above to adjust data to a specific province.',
        placement: 'top',
    });

    function exportProvinceChartToExcel() {
        const province = document.getElementById('provinceFilter').value;
        const params = new URLSearchParams();
        if (province) params.append('province', province);
    
        window.location.href = `/export-province-chart-excel/?${params.toString()}`;
    }
  
    // Province data for chart
    const provinceData = {{ province_data|safe }};
    const provinceLabels = provinceData.map(e => e['province__province']);
    const provinceCounts = provinceData.map(e => e.count);

    // Create the chart
    const provinceCtx = document.getElementById('provinceChart').getContext('2d');
    const provinceChart = new Chart(provinceCtx, {
        type: 'bar',
        data: {
            labels: provinceLabels,
            datasets: [{
                label: 'Province Distribution',
                data: provinceCounts,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
            }],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                },
            },
        },
    });

    // Export chart and data to PDF using generatePDF.js
    document.getElementById('exportButton').addEventListener('click', function () {
        // Capture chart as image
        const chartImageData = provinceChart.toBase64Image();

        // Prepare filters
        const provinceFilter = "{{ request.GET.province|default:'ALL' }}";
        const filters = `Province: ${provinceFilter}`;

        // Prepare table data
        const tableHeaders = ['Province', '# of Users'];
        const tableData = provinceLabels.map((province, index) => [province, provinceCounts[index]]);

        // Generate PDF using reusable function
        generatePDF({
            title: 'Freelancer Province Distribution Report',
            chartImageData: chartImageData,
            filters: filters,
            tableHeaders: tableHeaders,
            tableData: tableData,
            fileName: 'freelancer_province_distribution_summary.pdf',
            
        });
    });
</script>


{% endblock %}
